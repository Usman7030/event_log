"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const shared_pb_1 = require("../../generated/shared_pb");
const streams_grpc_pb_1 = require("../../generated/streams_grpc_pb");
const streams_pb_1 = require("../../generated/streams_pb");
const Client_1 = require("../Client");
const constants_1 = require("../constants");
const utils_1 = require("../utils");
const ReadStream_1 = require("./utils/ReadStream");
Client_1.Client.prototype.readStream = function (streamName, { maxCount = Number.MAX_SAFE_INTEGER, fromRevision = constants_1.START, resolveLinkTos = false, direction = constants_1.FORWARDS, ...baseOptions } = {}, readableOptions = {}) {
    const req = new streams_pb_1.ReadReq();
    const options = new streams_pb_1.ReadReq.Options();
    const streamOptions = new streams_pb_1.ReadReq.Options.StreamOptions();
    const uuidOption = new streams_pb_1.ReadReq.Options.UUIDOption();
    const identifier = (0, utils_1.createStreamIdentifier)(streamName);
    uuidOption.setString(new shared_pb_1.Empty());
    streamOptions.setStreamIdentifier(identifier);
    switch (fromRevision) {
        case constants_1.START: {
            streamOptions.setStart(new shared_pb_1.Empty());
            break;
        }
        case constants_1.END: {
            streamOptions.setEnd(new shared_pb_1.Empty());
            break;
        }
        default: {
            streamOptions.setRevision(fromRevision.toString(10));
            break;
        }
    }
    options.setStream(streamOptions);
    options.setResolveLinks(resolveLinkTos);
    options.setCount(maxCount.toString(10));
    options.setUuidOption(uuidOption);
    options.setNoFilter(new shared_pb_1.Empty());
    switch (direction) {
        case constants_1.FORWARDS: {
            options.setReadDirection(0);
            break;
        }
        case constants_1.BACKWARDS: {
            options.setReadDirection(1);
            break;
        }
    }
    req.setOptions(options);
    utils_1.debug.command("readStream: %O", {
        streamName,
        maxCount,
        options: {
            fromRevision,
            resolveLinkTos,
            direction,
            ...baseOptions,
        },
    });
    utils_1.debug.command_grpc("readStream: %g", req);
    const createGRPCStream = this.GRPCStreamCreator(streams_grpc_pb_1.StreamsClient, "readStream", (client) => client.read(req, ...this.callArguments(baseOptions, {
        deadline: Infinity,
    })));
    return new ReadStream_1.ReadStream(createGRPCStream, utils_1.convertGrpcEvent, readableOptions);
};
